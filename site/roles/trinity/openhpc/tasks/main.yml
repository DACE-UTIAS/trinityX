---

- name: Create trinity/ohpc dir for opt link to point at
  file:
    path: '{{ trix_ohpc }}'
    owner: root
    group: root
    state: directory
    mode: '0755'
  when: ansible_connection not in 'chroot'

- name: Create link so openhpc ends up on /trinity filesystem
  file:
    src: '{{ trix_ohpc }}'
    path: /opt/ohpc
    owner: root
    group: root
    state: link
  when: ansible_connection not in 'chroot'

- name: Create OpenHPC repo
  ansible.builtin.yum_repository:
    name: "openhpc"
    description: "OpenHPC repo"
    baseurl: "{{ lookup('ansible.builtin.vars', 'el' + ansible_distribution_major_version + '_openhpc_repo') }}"
    gpgcheck: false

- name: Create OpenHPC Updates repo
  ansible.builtin.yum_repository:
    name: "openhpc-updates"
    description: "OpenHPC Updates repo"
    baseurl: "{{ lookup('ansible.builtin.vars', 'el' + ansible_distribution_major_version + '_openhpc_updates_repo') }}"
    gpgcheck: false
  when: lookup('ansible.builtin.vars', 'el' + ansible_distribution_major_version + '_openhpc_updates_repo') is defined

- name: Ensure conflicting rpms from legacy TrinityX are not installed
  yum:
    name:
      - pdsh
      - environment-modules
    state: removed

- name: Install ohpc-base
  yum:
    name: ohpc-base
    state: installed
  when: ansible_connection not in 'chroot'

#- name: Install ohpc-base
#  yum:
#    name: ohpc-base
#    state: installed
#    enablerepo: rhel-7-server-optional-rpms
#  when: ansible_connection not in 'chroot' and ansible_distribution == "RedHat"

- name: Install ohpc-base-compute
  yum:
    name: ohpc-base-compute
    state: installed
  when: ansible_connection not in 'chroot'

- name: Install lmod dependencies on non-controller nodes
  yum:
    name:
      - lua-filesystem
      - lua-posix
    enablerepo: powertools
    state: installed
  when: ansible_connection in 'chroot'

- name: Create symlinks for pdsh and pdcp
  file:
    dest: "/usr/bin/{{ item }}"
    src: "/opt/ohpc/admin/pdsh/bin/{{ item }}"
    state: link
    force: yes
    follow: no
  with_items:
    - pdsh
    - pdcp

- name: Install lmod-ohpc
  yum:
    name: lmod-ohpc
    state: installed
    enablerepo: powertools

- name: Install profile for modules
  template:
    src: z_trinityx.sh.j2
    dest: /etc/profile.d/z_trinityx.sh

- name: Update NFS exports
  template:
    src: OHPC_exports.j2
    dest: '{{ nfs_exports_path }}/ohpc.exports'
  when: ansible_connection not in 'chroot'
  notify:
    - Export NFS

- file:
    src: '{{ nfs_exports_path }}/ohpc.exports'
    dest: '/etc/exports.d/ohpc.exports'
    state: link
    force: "yes"
  when: ansible_connection not in 'chroot'
  notify:
    - Export NFS

